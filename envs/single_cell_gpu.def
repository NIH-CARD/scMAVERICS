BootStrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

%environment
    export LC_ALL=en_US.utf-8
    export LANG=en_US.utf-8
    export LANGUAGE=en_US.UTF-8
    # Set BASH_ENV which points to init file loaded during non-interactive shell
    export BASH_ENV=/opt/etc/bashrc
    # Force loading of copied bashrc for interactive shell
    source /opt/etc/bashrc


%files
    single_cell_gpu.yml

%post
    # Create target dir for non-root-accessible bashrc
    mkdir -p /opt/etc

    # Ensure locales packages installed
    sed -i '/xenial.*universe/s/^#//g' /etc/apt/sources.list
    apt-get -y update
    apt-get install -y locales locales-all
    apt-get -y install g++
    apt-get install -y wget

    # Install Anaconda
    wget -c https://repo.anaconda.com/archive/Anaconda3-2020.02-Linux-x86_64.sh
    bash Anaconda3-2020.02-Linux-x86_64.sh -bfp /opt/conda
    export PATH=/opt/conda/bin:$PATH
    conda init
    conda install -c conda-forge anaconda
    

    # download and run NIH HPC NVIDIA driver installer
    wget https://raw.githubusercontent.com/NIH-HPC/gpu4singularity/master/gpu4singularity
    chmod u+rwx gpu4singularity
    export VERSION=375.66
    ./gpu4singularity --verbose \
        -u http://us.download.nvidia.com/XFree86/Linux-x86_64/"${VERSION}"/NVIDIA-Linux-x86_64-"${VERSION}".run \
        -V "${VERSION}"
    rm gpu4singularity

    # Create target dir for non-root-accessible bashrc
    mkdir -p /opt/etc

    # Define environment name. Doesn't really matter as it's auto-loaded regardless
    ENVNAME='single_cell_gpu'

    # Create environment using conda
    conda env create -n $ENVNAME -p /opt/etc/$ENV_NAME
    conda install conda-forge::jax 
    conda install -c pytorch magma-cuda121 
    conda install scvi-tools -c conda-forge
    
    # Finalize bashrc file
    echo "#! /bin/bash\n\nconda activate single_cell_gpu" > ~/.bashrc 
    conda init bash
    echo "echo \"Activating ${ENVNAME}\"" >>  ~/.bashrc
    echo "\nconda activate ${ENVNAME}" >> ~/.bashrc

    # Clean up installer files
    conda clean -a

    # Copy bashrc to non-root-accessible location
    cp ~/.bashrc /opt/etc/bashrc

# %runscript
    exec /bin/bash "$@"